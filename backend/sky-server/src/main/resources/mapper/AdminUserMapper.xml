<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.admin.AdminUserMapper">

    <select id="getAdminByUsername" parameterType="string" resultType="com.sky.entity.User">
        SELECT
            `id`,
            `role`,
            `username`,
            `phone`,
            `password_hash` AS `passwordHash`,
            `name`,
            `code`,
            `reader_type_id` AS `readerTypeId`,
            `status`,
            `create_time` AS `createTime`,
            `update_time` AS `updateTime`,
            `create_user` AS `createUser`,
            `update_user` AS `updateUser`,
            `is_deleted` AS `isDeleted`
        FROM `user`
        WHERE `is_deleted` = 0
          AND `status` = 1
          AND `role` = 1
          AND `username` = #{username}
        LIMIT 1
    </select>

    <select id="countReaders" resultType="long">
        SELECT COUNT(*)
        FROM `user` u
        WHERE u.`is_deleted` = 0
          AND u.`role` = 2
        <if test="status != null">
            AND u.`status` = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                u.`name` LIKE CONCAT('%', #{keyword}, '%')
                OR u.`code` LIKE CONCAT('%', #{keyword}, '%')
                OR u.`phone` LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>

    <select id="listReaders" resultType="com.sky.vo.AdminReaderVO">
        SELECT
            u.`id`,
            u.`name`,
            u.`code`,
            u.`phone`,
            u.`reader_type_id` AS `readerTypeId`,
            rt.`name` AS `readerTypeName`,
            u.`status`,
            u.`create_time` AS `createTime`
        FROM `user` u
        LEFT JOIN `reader_type` rt ON rt.`id` = u.`reader_type_id`
        WHERE u.`is_deleted` = 0
          AND u.`role` = 2
        <if test="status != null">
            AND u.`status` = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                u.`name` LIKE CONCAT('%', #{keyword}, '%')
                OR u.`code` LIKE CONCAT('%', #{keyword}, '%')
                OR u.`phone` LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY u.`create_time` DESC, u.`id` DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <update id="updatePasswordHash">
        UPDATE `user`
        SET `password_hash` = #{passwordHash},
            `update_user` = #{updateUser}
        WHERE `is_deleted` = 0
          AND `role` = 2
          AND `id` = #{id}
    </update>

    <update id="updateStatus">
        UPDATE `user`
        SET `status` = #{status},
            `update_user` = #{updateUser}
        WHERE `is_deleted` = 0
          AND `role` = 2
          AND `id` = #{id}
    </update>

</mapper>

