<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.admin.AdminBookMapper">

    <select id="count" resultType="long">
        SELECT COUNT(*)
        FROM `book` b
        WHERE b.`is_deleted` = 0
        <if test="status != null">
            AND b.`status` = #{status}
        </if>
        <if test="category != null and category != ''">
            AND b.`category` = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                b.`title` LIKE CONCAT('%', #{keyword}, '%')
                OR b.`author` LIKE CONCAT('%', #{keyword}, '%')
                OR b.`publisher` LIKE CONCAT('%', #{keyword}, '%')
                OR b.`isbn` LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>

    <select id="list" resultType="com.sky.entity.Book">
        SELECT
            b.`id`,
            b.`title`,
            b.`author`,
            b.`publisher`,
            b.`isbn`,
            b.`category`,
            b.`location`,
            b.`description`,
            b.`total_qty` AS `totalQty`,
            b.`available_qty` AS `availableQty`,
            b.`status`,
            b.`create_time` AS `createTime`,
            b.`update_time` AS `updateTime`,
            b.`create_user` AS `createUser`,
            b.`update_user` AS `updateUser`,
            b.`is_deleted` AS `isDeleted`
        FROM `book` b
        WHERE b.`is_deleted` = 0
        <if test="status != null">
            AND b.`status` = #{status}
        </if>
        <if test="category != null and category != ''">
            AND b.`category` = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                b.`title` LIKE CONCAT('%', #{keyword}, '%')
                OR b.`author` LIKE CONCAT('%', #{keyword}, '%')
                OR b.`publisher` LIKE CONCAT('%', #{keyword}, '%')
                OR b.`isbn` LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY b.`update_time` DESC, b.`id` DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="getById" resultType="com.sky.entity.Book">
        SELECT
            `id`,
            `title`,
            `author`,
            `publisher`,
            `isbn`,
            `category`,
            `location`,
            `description`,
            `total_qty` AS `totalQty`,
            `available_qty` AS `availableQty`,
            `status`,
            `create_time` AS `createTime`,
            `update_time` AS `updateTime`,
            `create_user` AS `createUser`,
            `update_user` AS `updateUser`,
            `is_deleted` AS `isDeleted`
        FROM `book`
        WHERE `is_deleted` = 0
          AND `id` = #{id}
        LIMIT 1
    </select>

    <insert id="insert" parameterType="com.sky.entity.Book" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `book` (
            `title`, `author`, `publisher`, `isbn`, `category`, `location`, `description`,
            `total_qty`, `available_qty`, `status`,
            `create_user`, `update_user`, `is_deleted`
        )
        VALUES (
            #{title},
            #{author},
            #{publisher},
            #{isbn},
            #{category},
            #{location},
            #{description},
            #{totalQty},
            #{availableQty},
            #{status},
            #{createUser},
            #{updateUser},
            0
        )
    </insert>

    <update id="update" parameterType="com.sky.entity.Book">
        UPDATE `book`
        SET `title` = #{title},
            `author` = #{author},
            `publisher` = #{publisher},
            `isbn` = #{isbn},
            `category` = #{category},
            `location` = #{location},
            `description` = #{description},
            `total_qty` = #{totalQty},
            `available_qty` = #{availableQty},
            `status` = #{status},
            `update_user` = #{updateUser}
        WHERE `is_deleted` = 0
          AND `id` = #{id}
    </update>

    <update id="softDelete">
        UPDATE `book`
        SET `is_deleted` = 1,
            `update_user` = #{updateUser}
        WHERE `is_deleted` = 0
          AND `id` = #{id}
    </update>

</mapper>

